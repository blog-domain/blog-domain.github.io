<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300,300italic,400,400italic,700,700italic|New+Rocker:300,300italic,400,400italic,700,700italic|Fira+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/lib/animate-css/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"merikanto.org","root":"/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#6bb0e8","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="This is the fourth post in a series of posts to cover different aspects of Spring Boot. Please note that the entire post isn’t necessarily only written in English.  In this post, I am going to cover t">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot - 04 Spring Security">
<meta property="og:url" content="http://merikanto.org/2020/SpringBoot-04/index.html">
<meta property="og:site_name" content="Merikanto">
<meta property="og:description" content="This is the fourth post in a series of posts to cover different aspects of Spring Boot. Please note that the entire post isn’t necessarily only written in English.  In this post, I am going to cover t">
<meta property="og:locale" content="de_DE">
<meta property="og:image" content="http://merikanto.org/images/posts/200421.png">
<meta property="article:published_time" content="2020-04-20T23:00:00.000Z">
<meta property="article:modified_time" content="2020-04-20T23:00:00.000Z">
<meta property="article:author" content="Merikanto">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://merikanto.org/images/posts/200421.png">

<link rel="canonical" href="http://merikanto.org/2020/SpringBoot-04/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'de'
  };
</script>

  <title>Spring Boot - 04 Spring Security | Merikanto</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Navigationsleiste an/ausschalten">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Merikanto</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一簫一劍平生意，負盡狂名十五年</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-blog">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Blog</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Kategorien</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Zeitleiste</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>Info</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Suchen
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Suchbegriff..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Übersicht
        </li>
        <li class="sidebar-nav-overview">
          Info
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Debug"><span class="nav-number">1.</span> <span class="nav-text">Debug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-Configuration"><span class="nav-number">2.</span> <span class="nav-text">Basic Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add-User-Store"><span class="nav-number">3.</span> <span class="nav-text">Add User Store</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#In-memory"><span class="nav-number">3.1.</span> <span class="nav-text">In-memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LDAP-backed"><span class="nav-number">3.2.</span> <span class="nav-text">LDAP-backed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDBC-based"><span class="nav-number">3.3.</span> <span class="nav-text">JDBC-based</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-User-Detail"><span class="nav-number">3.4.</span> <span class="nav-text">Custom User Detail</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Entity"><span class="nav-number">3.4.1.</span> <span class="nav-text">User Entity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Repository"><span class="nav-number">3.4.2.</span> <span class="nav-text">User Repository</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Details-Service"><span class="nav-number">3.4.3.</span> <span class="nav-text">User Details Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Details-Service-Implementation"><span class="nav-number">3.4.4.</span> <span class="nav-text">User Details Service Implementation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Modify-SecurityConfig"><span class="nav-number">3.4.5.</span> <span class="nav-text">Modify SecurityConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Controller"><span class="nav-number">3.4.6.</span> <span class="nav-text">User Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#A-Separate-Registration-Form"><span class="nav-number">3.4.7.</span> <span class="nav-text">A Separate Registration Form</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Securing-Web-Requests"><span class="nav-number">4.</span> <span class="nav-text">Securing Web Requests</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Secure-Requests"><span class="nav-number">4.1.</span> <span class="nav-text">Secure Requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Login-amp-Logout"><span class="nav-number">4.2.</span> <span class="nav-text">Custom Login &amp; Logout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF"><span class="nav-number">4.3.</span> <span class="nav-text">CSRF</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Know-Your-User"><span class="nav-number">5.</span> <span class="nav-text">Know Your User</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Merikanto"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Merikanto</p>
  <div class="site-description" itemprop="description">知我罪我，其惟春秋</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">Kategorien</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">Tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Merikanto" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Merikanto" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ks.merikanto@gmail.com" title="E-Mail → mailto:ks.merikanto@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title">
      　　
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.sigure.jp/" title="http:&#x2F;&#x2F;www.sigure.jp&#x2F;" rel="noopener" target="_blank">　凛として時雨　</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tools.kali.org/tools-listing" title="https:&#x2F;&#x2F;tools.kali.org&#x2F;tools-listing" rel="noopener" target="_blank">All Kali Tools</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.shodan.io/" title="https:&#x2F;&#x2F;www.shodan.io&#x2F;" rel="noopener" target="_blank">Shodan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://0pointer.net/blog/archives.html" title="https:&#x2F;&#x2F;0pointer.net&#x2F;blog&#x2F;archives.html" rel="noopener" target="_blank">Pid Eins</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.allthingsdistributed.com/" title="https:&#x2F;&#x2F;www.allthingsdistributed.com&#x2F;" rel="noopener" target="_blank">All Things Distributed</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.contrapositivediary.com/?p=1396" title="https:&#x2F;&#x2F;www.contrapositivediary.com&#x2F;?p&#x3D;1396" rel="noopener" target="_blank">Jeff Duntemann</a>
        </li>
    </ul>
  </div>

      </section>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/Merikanto" class="github-corner" title="Check out my GitHub" aria-label="Check out my GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="de">
    <link itemprop="mainEntityOfPage" href="http://merikanto.org/2020/SpringBoot-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Merikanto">
      <meta itemprop="description" content="知我罪我，其惟春秋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Merikanto">
    </span>

    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Boot - 04 Spring Security
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              <time title="Erstellt: 2020-04-21 00:00:00" itemprop="dateCreated datePublished" datetime="2020-04-21T00:00:00+01:00">2020-04-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">in</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Dev/" itemprop="url" rel="index"><span itemprop="name">Dev</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Aufrufe" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="far fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Aufrufe: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbole im Artikel gezählt">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbole im Artikel gezählt: </span>
              <span>7k Wörter</span>
            </span>
            <span class="post-meta-item" title="Lesezeit">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Lesezeit &asymp;</span>
              <span>9 min</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>This is the fourth post in a series of posts to cover different aspects of Spring Boot. Please note that the entire post isn’t necessarily only written in English. </p>
<p>In this post, I am going to cover the basics of Spring Security.</p>
<span id="more"></span>

<br>

<hr>
<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><div class="note warning"><p><strong>Do not litter security-unrelated code with security code!</strong></p>
</div>



<br>





<p><strong>Break <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/44071058/13408151">Circular Dependency</a>:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Requested bean is currently in creation: Is there an unresolvable circular reference?</span><br></pre></td></tr></table></figure>

<p>Use <strong><code>@Lazy</code></strong> before any of the mentioned <code>@Autowired</code> or <code>@Bean</code>.</p>
<br>





<p><strong>About Roles:</strong></p>
<p>Use <code>hasRole(&quot;User&quot;)</code> instead of <code>hasRole(&quot;ROLE_USER&quot;)</code>, because <code>ROLE_</code> is automatically added.</p>
<br>



<hr>
<h2 id="Basic-Configuration"><a href="#Basic-Configuration" class="headerlink" title="Basic Configuration"></a>Basic Configuration</h2><p>Enable Spring Security (the <strong>ONLY</strong> package needed for all security-related configs):</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<br>



<p>Spring Security starter provides the following <strong>features</strong>:</p>
<ul>
<li>  All HTTP request paths need authentication</li>
<li>  <u>No specific roles or authorities</u> are required (Only one user, with the username <code>user</code>)</li>
<li>  Login page made by Spring Security</li>
</ul>
<br>

<img data-src="/images/posts/200421.png" style="zoom: 80%;" />





<br>



<hr>
<h2 id="Add-User-Store"><a href="#Add-User-Store" class="headerlink" title="Add User Store"></a>Add User Store</h2><p>What we <strong>need</strong> to configure:</p>
<ul>
<li>  Prompt a customized login page</li>
<li>  Signup page, for multiple users</li>
<li>  Apply <u>different security rules for different request paths</u>.  e.g. The homepage and signup page shouldn’t require authentication at all</li>
</ul>
<br>





<p>Configure a <strong>user store</strong> that handles multiple users:</p>
<ul>
<li>  In-memory</li>
<li>  JDBC-based</li>
<li>  LDAP-backed</li>
<li>  Custom user details service (complete customization)</li>
</ul>
<br>





<p><strong>Barebones config class with <code>@Override</code>:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<br>





<h3 id="In-memory"><a href="#In-memory" class="headerlink" title="In-memory"></a><u>In-memory</u></h3><blockquote>
<p>  Convenient for testing purposes / simple apps, but doesn’t allow easy editing of users.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Must have the PasswordEncoder in Spring Security 5, otherwise give errors</span></span><br><span class="line">    PasswordEncoder encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接在 Config 里面 define username &amp; password</span></span><br><span class="line">    auth.inMemoryAuthentication()</span><br><span class="line">        .withUser(<span class="string">&quot;Merikanto&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Need to add &#123;noop&#125;, to enable NoOpPasswordEncoder</span></span><br><span class="line">        .password(<span class="string">&quot;&#123;noop&#125;123456&quot;</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;ROLE_USER&quot;</span>)</span><br><span class="line">    .and()</span><br><span class="line">        .withUser(<span class="string">&quot;KK&quot;</span>)</span><br><span class="line">        .password(<span class="string">&quot;&#123;noop&#125;123456&quot;</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;ROLE_USER&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<br>





<h3 id="LDAP-backed"><a href="#LDAP-backed" class="headerlink" title="LDAP-backed"></a><u>LDAP-backed</u></h3><blockquote>
<p>  LDAP: Lightweight Directory Access Protocol</p>
</blockquote>
<br>





<p>The default strategy for authenticating against LDAP is to perform a <strong>bind operation</strong>, authenticating the user <u>directly to the LDAP server</u>. </p>
<p>Another option is to perform a <strong>comparison operation</strong>. This involves sending the entered password to the LDAP directory and asking the server to compare the password against a user’s password attribute. Because the comparison is done within the LDAP server, the actual password remains secret.</p>
<br>





<p><strong>Basic Config:</strong></p>
<ul>
<li>  By default, users &amp; groups base queries are empty:  the search will be done from the root of LDAP hierarchy.</li>
<li>  With specifying the Base, rather than search from root, search will be done where the <strong>organizational unit</strong> is people.</li>
<li>  Add password comparison, for the <strong>comparison operation</strong>. Plus specify a different password attribute name.</li>
</ul>
<br>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    auth.ldapAuthentication()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Filters below: provide base LDAP queries (search for users &amp; groups)</span></span><br><span class="line">        .userSearchFilter(<span class="string">&quot;(uid=&#123;0&#125;)&quot;</span>)</span><br><span class="line">        .groupSearchFilter(<span class="string">&quot;member=&#123;0&#125;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Specify base queries for finding users &amp; groups</span></span><br><span class="line">        .userSearchBase(<span class="string">&quot;ou=people&quot;</span>)</span><br><span class="line">        .groupSearchBase(<span class="string">&quot;ou=groups&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Name for the password attribute is now: Passphrase</span></span><br><span class="line">        .passwordCompare()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Need another encoder, to prevent MITM interception</span></span><br><span class="line">        .passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder())</span><br><span class="line">        .passwordAttribute(<span class="string">&quot;Passphrase&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<br>





<p><strong>Contact LDAP server:</strong></p>
<blockquote>
<p>   The default LDAP server is on <strong><code>localhost:33389</code></strong>.</p>
</blockquote>
<br>





<p>When the LDAP server starts, it will attempt to load data from any <strong>LDIF files</strong> that it can find in the classpath. <strong>LDIF (LDAP Data Interchange Format)</strong> is a standard way of representing LDAP data in a plain text file. Each record is composed of one or more lines, each containing <u>a <code>name:value</code> pair</u>. Records are separated from each other by blank lines.</p>
<br>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add to the last line</span></span><br><span class="line"></span><br><span class="line">.contextSource</span><br><span class="line">    .root(<span class="string">&quot;dc=tacocloud, dc=com&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ask the server to load content from the users.ldif file at classpath root</span></span><br><span class="line">    .ldif(<span class="string">&quot;classpath:users.ldif&quot;</span>);</span><br></pre></td></tr></table></figure>



<br>





<p>A sample LDIF file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dn:</span> <span class="string">ou=groups,dc=tacocloud,dc=com</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">top</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">organizationalUnit</span></span><br><span class="line"><span class="attr">ou:</span> <span class="string">groups</span></span><br><span class="line"><span class="attr">dn:</span> <span class="string">ou=people,dc=tacocloud,dc=com</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">top</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">organizationalUnit</span></span><br><span class="line"><span class="attr">ou:</span> <span class="string">people</span></span><br><span class="line"><span class="attr">dn:</span> <span class="string">uid=buzz,ou=people,dc=tacocloud,dc=com</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">top</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">person</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">organizationalPerson</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">inetOrgPerson</span></span><br><span class="line"><span class="attr">cn:</span> <span class="string">Buzz</span> <span class="string">Lightyear</span></span><br><span class="line"><span class="attr">sn:</span> <span class="string">Lightyear</span></span><br><span class="line"><span class="attr">uid:</span> <span class="string">buzz</span></span><br><span class="line"><span class="attr">userPassword:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">dn:</span> <span class="string">cn=tacocloud,ou=groups,dc=tacocloud,dc=com</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">top</span></span><br><span class="line"><span class="attr">objectclass:</span> <span class="string">groupOfNames</span></span><br><span class="line"><span class="attr">cn:</span> <span class="string">tacocloud</span></span><br><span class="line"><span class="attr">member:</span> <span class="string">uid=buzz,ou=people,dc=tacocloud,dc=com</span></span><br></pre></td></tr></table></figure>





<br>







<h3 id="JDBC-based"><a href="#JDBC-based" class="headerlink" title="JDBC-based"></a><u>JDBC-based</u></h3><blockquote>
<p>   Maintain user info in a relational DB with JDBC.</p>
</blockquote>
<br>





<p>Spring Security’s <strong>default user queries</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WITH auth.jdbcAuthentication().dataSource(dataSource):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Authentication: Get username &amp; password</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">final</span> String DEF_USERS_BY_USERNAME_QUERY <span class="operator">=</span></span><br><span class="line">    &quot;select username,password,enabled from users where username = ?&quot;;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Authorization: look up user&#x27;s granted authorities</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">final</span> String DEF_AUTHORITIES_BY_USERNAME_QUERY <span class="operator">=</span></span><br><span class="line">    &quot;select username,authority from authorities where username = ?&quot;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- Authorization: look up granted user group</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">final</span> String DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY <span class="operator">=</span></span><br><span class="line">    &quot;select g.id, g.group_name, ga.authority &quot; <span class="operator">+</span></span><br><span class="line">    &quot;from groups g, group_members gm, group_authorities ga &quot; <span class="operator">+</span></span><br><span class="line">    &quot;where gm.username = ? and g.id = ga.group_id and g.id = gm.group_id&quot;;</span><br></pre></td></tr></table></figure>



<br>





<p><strong>Customized config:</strong></p>
<blockquote>
<p>  Note: All the queries take username as the only parameter.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set datasource, for DB access</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only override the authentication &amp; basic auth queries</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    auth.jdbcAuthentication().dataSource(dataSource)</span><br><span class="line">        .usersByUsernameQuery(</span><br><span class="line">        	<span class="string">&quot;select username, password, enabled from Users &quot;</span> +</span><br><span class="line">        	<span class="string">&quot;where username=?&quot;</span>)</span><br><span class="line">        .authoritiesByUsernameQuery(</span><br><span class="line">        	<span class="string">&quot;select username, authority from UserAuthorities &quot;</span> +</span><br><span class="line">        	<span class="string">&quot;where username=?&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<p><strong>Encoding passwords</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Added to the last line</span></span><br><span class="line">.passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder(<span class="string">&quot;merikanto&quot;</span>));</span><br></pre></td></tr></table></figure>



<br>



<p><strong>Other Cryptos:</strong></p>
<blockquote>
<p>  Note: <code>StandardPasswordEncoder</code> using SHA256 is deprecated after Spring Security 5.1.5.</p>
</blockquote>
<ul>
<li>  <strong>NoOp</strong>PasswordEncoder —Applies no encoding</li>
<li>  <strong>BCrypt</strong>PasswordEncoder —Applies bcrypt strong hashing encryption</li>
<li>  <strong>Pbkdf2</strong>PasswordEncoder —Applies PBKDF2 encryption</li>
<li>  <strong>SCrypt</strong>PasswordEncoder —Applies scrypt hashing encryption</li>
</ul>
<br>





<p>The Password encoder <strong>interface</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>



<div class="note default"><p><strong>Clarification:</strong></p>
<p>The password in the DB is never decoded. </p>
<p>The plaintext password entered by the user is encoded using the same algorithm, and then compared with the encoded password in the DB (using the <code>matches()</code> method)</p>
</div>





<br>





<h3 id="Custom-User-Detail"><a href="#Custom-User-Detail" class="headerlink" title="Custom User Detail"></a><u>Custom User Detail</u></h3><h4 id="User-Entity"><a href="#User-Entity" class="headerlink" title="User Entity"></a>User Entity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access= AccessLevel.PRIVATE, force=true)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意是 implements UserDetails interface from Spring Security</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fullname;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String street;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String city;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String state;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String zip;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String phoneNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面的方法可以自动生成，点击 implements</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// Return a collection of authorities granted to the user;</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// In this case, returns a collection indicating that,</span></span><br><span class="line">        <span class="comment">// All users are granted with the ROLE_USER authority </span></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;ROLE_USER&quot;</span>)); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<h4 id="User-Repository"><a href="#User-Repository" class="headerlink" title="User Repository"></a>User Repository</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Look up a user by username</span></span><br><span class="line">    <span class="function">User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<h4 id="User-Details-Service"><a href="#User-Details-Service" class="headerlink" title="User Details Service"></a>User Details Service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Either return a UserDetails object, or throw an exception</span></span><br><span class="line">    <span class="function">UserDetails <span class="title">loadByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<h4 id="User-Details-Service-Implementation"><a href="#User-Details-Service-Implementation" class="headerlink" title="User Details Service Implementation"></a>User Details Service Implementation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ServiceImpl is injected with an instance of UserRepo via the constructor</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsServiceImpl</span><span class="params">(UserRepository userRepo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepo = userRepo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// loadByUsername: Never return null!</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        User user = userRepo.findByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">&quot;User [ &quot;</span> + username + <span class="string">&quot; ] is not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<h4 id="Modify-SecurityConfig"><a href="#Modify-SecurityConfig" class="headerlink" title="Modify SecurityConfig"></a>Modify SecurityConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意 autowired 的是 import 的东西，security core 里面的，而不是自己写的 service！</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Still need a password encoder</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">encoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pbkdf2PasswordEncoder(<span class="string">&quot;Merikanto&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        auth.userDetailsService(userDetailsService)</span><br><span class="line">                .passwordEncoder(encoder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Line 21:</strong><code>.passwordEncoder(encoder());</code></p>
<p>It appears that we call the <code>encoder()</code> method and pass its returned value to <code>passwordEncoder()</code> .</p>
<p>However, since the <code>encoder()</code> method is annotated with <code>@Bean</code> , it will be used to <strong>declare a <code>PasswordEncoder</code> bean in the Spring application context</strong>. Any calls to <code>encoder()</code> will then be <u>intercepted to return the bean instance from the application context</u>.</p>
<br>





<h4 id="User-Controller"><a href="#User-Controller" class="headerlink" title="User Controller"></a>User Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RegistrationController</span><span class="params">(UserRepository userRepo, PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepo = userRepo;</span><br><span class="line">        <span class="keyword">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">registerForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;registration&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(RegistrationForm form)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Pass to toUser (code is below)</span></span><br><span class="line">        userRepo.save(form.toUser(passwordEncoder));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<br>





<h4 id="A-Separate-Registration-Form"><a href="#A-Separate-Registration-Form" class="headerlink" title="A Separate Registration Form"></a>A Separate Registration Form</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String fullname;</span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line">    <span class="keyword">private</span> String zip;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note here, toUser uses the above properties to create a new User object</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">toUser</span><span class="params">(PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(</span><br><span class="line">            </span><br><span class="line">            	<span class="comment">// First encode the password, then controller saves to the DB </span></span><br><span class="line">                username, passwordEncoder.encode(password),</span><br><span class="line">                fullname, street, city, state, zip, phone);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<br>



<hr>
<h2 id="Securing-Web-Requests"><a href="#Securing-Web-Requests" class="headerlink" title="Securing Web Requests"></a>Securing Web Requests</h2><br>





<h3 id="Secure-Requests"><a href="#Secure-Requests" class="headerlink" title="Secure Requests"></a><u>Secure Requests</u></h3><p>Configs with <code>HttpSecurity</code>:</p>
<ul>
<li>  Require that certain security conditions must be met before serving a request</li>
<li>  Configure a custom login page, and enable logout</li>
<li>  Configure cross-site request forgery protection (CSRF)</li>
</ul>
<br>





<p><strong>Specify 2 security rules:</strong></p>
<ul>
<li>  Requests for <code>/design</code> and <code>/orders</code> should be for users with a granted authority of <code>ROLE_USER</code> </li>
<li>  All requests should be permitted to all users</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HttpSecurity object</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/deign&quot;</span>, <span class="string">&quot;/orders&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/**&quot;</span>).permitAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>



<p><strong><u>Important:</u></strong> </p>
<p>The order of the rules are important. <strong>Security rules declared first take precedence over those declared lower down</strong>. </p>
<p>If we reverse the order, all requests would have <code>permitAll()</code> applied to them, and the rule for <code>/design</code> and <code>/orders</code> requests would have no effect.</p>
<br>





<p><strong>Spring Security’s config methods for securing paths:</strong></p>
<blockquote>
<p>  <strong>SpEL</strong>: <em>Spring</em> Expression Language</p>
</blockquote>
<br>





<table>
<thead>
<tr>
<th>Method</th>
<th>What It Does</th>
</tr>
</thead>
<tbody><tr>
<td><code>access(String)</code></td>
<td>Allows access if the given SpEL expression evaluates to true</td>
</tr>
<tr>
<td><code>rememberMe()</code></td>
<td>Allows access for users who are authenticated via remember-me</td>
</tr>
<tr>
<td><code>permitAll()</code></td>
<td>Allows access unconditionally</td>
</tr>
<tr>
<td><code>denyAll()</code></td>
<td>Denies access unconditionally</td>
</tr>
<tr>
<td>.</td>
<td></td>
</tr>
<tr>
<td><code>authenticated()</code></td>
<td>Allows access to authenticated users</td>
</tr>
<tr>
<td><code>fullyAuthenticated()</code></td>
<td>Allows access if the user is fully authenticated (not remembered)</td>
</tr>
<tr>
<td><code>hasAnyAuthority(String...)</code></td>
<td>Allows access if the user has any of the given authorities</td>
</tr>
<tr>
<td><code>hasAnyRole(String...)</code></td>
<td>Allows access if the user has any of the given roles</td>
</tr>
<tr>
<td><code>hasAuthority(String)</code></td>
<td>Allows access if the user has the given authority</td>
</tr>
<tr>
<td><code>hasIpAddress(String)</code></td>
<td>Allows access if the request comes from the given IP address</td>
</tr>
<tr>
<td><code>hasRole(String)</code></td>
<td>Allows access if the user has the given role</td>
</tr>
<tr>
<td>.</td>
<td></td>
</tr>
<tr>
<td><code>not()</code></td>
<td>Negates the effect of any of the other access methods</td>
</tr>
<tr>
<td><code>anonymous()</code></td>
<td>Allows access to anonymous users</td>
</tr>
</tbody></table>
<br>





<br>







<p><strong>Spring Security Extension to SpEL</strong></p>
<table>
<thead>
<tr>
<th>Security Expression</th>
<th>What It Evaluates</th>
</tr>
</thead>
<tbody><tr>
<td><code>authentication</code></td>
<td>The user’s authentication object</td>
</tr>
<tr>
<td><code>isRememberMe()</code></td>
<td><code>true</code> if the user was authenticated via remember-me</td>
</tr>
<tr>
<td><code>denyAll</code></td>
<td>Always evaluates to false</td>
</tr>
<tr>
<td><code>permitAll</code></td>
<td>Always evaluates to true</td>
</tr>
<tr>
<td>.</td>
<td></td>
</tr>
<tr>
<td><code>isAuthenticated()</code></td>
<td><code>true</code> if the user is authenticated</td>
</tr>
<tr>
<td><code>isFullyAuthenticated()</code></td>
<td><code>true</code> if the user is fully authenticated (not with remember-me)</td>
</tr>
<tr>
<td><code>hasAnyRole(list of roles)</code></td>
<td><code>true</code> if the user has any of the given roles</td>
</tr>
<tr>
<td><code>hasRole(role)</code></td>
<td><code>true</code> if the user has the given role</td>
</tr>
<tr>
<td><code>hasIpAddress(IP address)</code></td>
<td><code>true</code> if the request comes from the given IP address</td>
</tr>
<tr>
<td>.</td>
<td></td>
</tr>
<tr>
<td><code>isAnonymous()</code></td>
<td><code>true</code> if the user is anonymous</td>
</tr>
<tr>
<td><code>principal</code></td>
<td>The user’s principal object</td>
</tr>
</tbody></table>
<br>





<p><strong>Example:</strong></p>
<p><u>Only allow authenticated user to place order on Tuesday:</u></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/design&quot;</span>, <span class="string">&quot;/orders&quot;</span>)</span><br><span class="line">        .access(<span class="string">&quot;hasRole(&#x27;USER&#x27;) &amp;&amp; T(java.util.Calendar).getInstance().get(&quot;</span>+</span><br><span class="line">        <span class="string">&quot;T(java.util.Calendar).DAY_OF_WEEK) == &quot;</span> +</span><br><span class="line">        <span class="string">&quot;T(java.util.Calendar).TUESDAY&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        .antMatchers(“/”, <span class="string">&quot;/**&quot;</span>).access(<span class="string">&quot;permitAll&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>









<h3 id="Custom-Login-amp-Logout"><a href="#Custom-Login-amp-Logout" class="headerlink" title="Custom Login &amp; Logout"></a><u>Custom Login &amp; Logout</u></h3><p><strong>Add a ViewController Path in WebConfig:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">    registry.addViewController(<span class="string">&quot;/&quot;</span>).setViewName(<span class="string">&quot;home&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加上这一行</span></span><br><span class="line">    registry.addViewController(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<p><strong>Add to <code>SecurityConfig</code>:</strong></p>
<blockquote>
<p>  By default, Spring Security listens for login requests at <code>/login</code>, and expects that the username and password fields be named <code>username</code> and <code>password</code> . </p>
<p>  But we can change it through the config below:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/deign&quot;</span>, <span class="string">&quot;/orders&quot;</span>).access(<span class="string">&quot;hasRole(&#x27;USER&#x27;)&quot;</span>)</span><br><span class="line">    .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/**&quot;</span>).permitAll()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Login Form 指向 /login</span></span><br><span class="line">    .and().formLogin().loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登陆成功后，将被强行带到 /design 页面（force = true），无论之前在哪个页面</span></span><br><span class="line">    .defaultSuccessUrl(<span class="string">&quot;/design&quot;</span>, <span class="keyword">true</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Customize login, 现在登陆入口变成了 /hello， 用户名和密码的field name也更改了</span></span><br><span class="line">    .loginProcessingUrl(<span class="string">&quot;/hello&quot;</span>)</span><br><span class="line">    .usernameParameter(<span class="string">&quot;uname&quot;</span>)</span><br><span class="line">    .passwordParameter(<span class="string">&quot;pword&quot;</span>);</span><br></pre></td></tr></table></figure>



<br>





<p><strong>Logging Out</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 末尾加上这行</span></span><br><span class="line">.and().logout().logoutSuccessUrl(<span class="string">&quot;/&quot;</span>);</span><br></pre></td></tr></table></figure>





<br>





<h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a><u>CSRF</u></h3><div class="note primary"><p><strong>Spring Security has built-in CSRF protection, and it’s enabled by default</strong>. </p>
</div>



<p>Cross-site request forgery (CSRF) is a common security attack. It involves subjecting a user to visit a maliciously designed web page that <u>automatically &amp; secretly submits a form to another application on behalf of a user</u>. For instance, a user may be presented with a form on an attacker’s website that automatically posts to a URL on the user’s banking website to transfer money. </p>
<p>To protect against such attacks, applications can generate a <strong>CSRF token</strong> upon displaying a form, p<u>lace that token in a hidden field, and then save it for later use on the server</u>. When the form is submitted, the token is sent back to the server along with the rest of the form data. The request is then intercepted by the server and compared with the token that was originally generated. If the token matches, the request is allowed to proceed. </p>
<br>

<hr>
<h2 id="Know-Your-User"><a href="#Know-Your-User" class="headerlink" title="Know Your User"></a>Know Your User</h2><blockquote>
<p>   Link User with Order:</p>
<p>  <strong>Information about the authenticated user</strong> can be obtained via the <u><code>SecurityContext</code> object</u>, or injected into controllers using <u><code>@AuthenticationPrincipal</code></u> .</p>
</blockquote>
<br>





<p>Add this to the <code>Order</code> entity:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="keyword">private</span> User user;</span><br></pre></td></tr></table></figure>



<br>





<p>Determine which  user is associated with which order(s):</p>
<ul>
<li>  Inject a <code>Principal</code> object into the controller method</li>
<li>  Inject an <code>Authentication</code> object into the controller method</li>
<li>  Use <code>SecurityContextHolder</code> to get at the security context</li>
<li>  Use an <u><code>@AuthenticationPrincipal</code></u> annotated method</li>
</ul>
<br>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processOrder</span><span class="params">(<span class="meta">@Valid</span> Order order, Errors errors, SessionStatus sessionStatus, </span></span></span><br><span class="line"><span class="params"><span class="function">	Principal principal)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加上这些</span></span><br><span class="line">    User user = userRepository.findByUsername(</span><br><span class="line">    principal.getName());</span><br><span class="line">    order.setUser(user);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>上面的方法是没问题的，但这个是 Bad Practice!</strong></p>
<p><strong>Do not litter security-unrelated code with security code!</strong></p>
<br>





<p><strong>方法一</strong>（Cleanest Solution）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @AuthPrincipal limits the security-specific code to the annotation itself</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processOrder</span><span class="params">(<span class="meta">@Valid</span> Order order, Errors errors, SessionStatus sessionStatus, </span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="meta">@AuthenticationPrincipal</span> User user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 换成这一行</span></span><br><span class="line">    order.setUser(user);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>





<p><strong>方法二</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">User user = (User) authentication.getPrincipal();</span><br></pre></td></tr></table></figure>

<p>此方法的好处是：</p>
<p>It can be <strong>used anywhere in the application</strong>, not only in a controller’s handler methods. This makes it <u>suitable for use in lower levels of the code</u>.</p>
<br>



<br>




    </div>

    
    
    <div>
    
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Beitragsautor:  </strong>Merikanto
  </li>
  <li class="post-copyright-link">
    <strong>Beitragslink: </strong>
    <a href="http://merikanto.org/2020/SpringBoot-04/" title="Spring Boot - 04 Spring Security">http://merikanto.org/2020/SpringBoot-04/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Urheberrechtshinweis:  </strong>Alle Artikel in diesem Blog sind unter <a target="_blank" rel="noopener" href="https://github.com/Merikanto">Merikanto</a> lizenziert, außer es wird anders angegeben.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/SpringBoot-03/" rel="prev" title="Spring Boot - 03 Spring Data">
      <i class="fa fa-chevron-left"></i> Spring Boot - 03 Spring Data
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/Spring-Cloud/" rel="next" title="Microservices With Spring Cloud">
      Microservices With Spring Cloud <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>  
  </span>
  <a href="/tools"><span class="author" itemprop="copyrightHolder">Merikanto</span></a>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Alle Besucher">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Alle Aufrufe">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>


  

  
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#ededed',
  buttonColorLight: '#4a4a4a',
  saveInCookies: true,
  label: '◒',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

<script>
  var disqus_config = function() {
    this.page.url = "http://merikanto.org/2020/SpringBoot-04/";
    this.page.identifier = "2020/SpringBoot-04/";
    this.page.title = "Spring Boot - 04 Spring Security";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://Merikanto-Blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>


  <script async src="/js/cursor/love.min.js"></script>

</body>
</html>
