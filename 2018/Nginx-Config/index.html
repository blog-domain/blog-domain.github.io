<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300,300italic,400,400italic,700,700italic|New+Rocker:300,300italic,400,400italic,700,700italic|Fira+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/lib/animate-css/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"merikanto.org","root":"/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#6bb0e8","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="Apache and Nginx are two popular open-source web servers often used with PHP. It can be useful to run both of them on the same virtual machine when hosting multiple websites which have varied requirem">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx as Web Server &amp; Reverse Proxy for Apache with SSL">
<meta property="og:url" content="http://merikanto.org/2018/Nginx-Config/index.html">
<meta property="og:site_name" content="Merikanto">
<meta property="og:description" content="Apache and Nginx are two popular open-source web servers often used with PHP. It can be useful to run both of them on the same virtual machine when hosting multiple websites which have varied requirem">
<meta property="og:locale" content="de_DE">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-0.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-1.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-2.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-3.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-4.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-5.png">
<meta property="og:image" content="http://merikanto.org/images/posts/181111-6.png">
<meta property="article:published_time" content="2018-11-11T00:00:00.000Z">
<meta property="article:modified_time" content="2018-11-11T00:00:00.000Z">
<meta property="article:author" content="Merikanto">
<meta property="article:tag" content="DevOps">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://merikanto.org/images/posts/181111-0.png">

<link rel="canonical" href="http://merikanto.org/2018/Nginx-Config/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'de'
  };
</script>

  <title>Nginx as Web Server & Reverse Proxy for Apache with SSL | Merikanto</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Navigationsleiste an/ausschalten">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Merikanto</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一簫一劍平生意，負盡狂名十五年</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-blog">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Blog</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Kategorien</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Zeitleiste</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>Info</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Suchen
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Suchbegriff..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Übersicht
        </li>
        <li class="sidebar-nav-overview">
          Info
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Config-Apache-amp-PHP-FPM"><span class="nav-number">1.</span> <span class="nav-text">Config Apache &amp; PHP-FPM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-mod-fastcgi"><span class="nav-number">2.</span> <span class="nav-text">Use mod_fastcgi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Verify-PHP-Functionality"><span class="nav-number">3.</span> <span class="nav-text">Verify PHP Functionality</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Virtual-Hosts-for-Apache"><span class="nav-number">4.</span> <span class="nav-text">Create Virtual Hosts for Apache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-amp-Config-Nginx"><span class="nav-number">5.</span> <span class="nav-text">Install &amp; Config Nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-for-Apache%E2%80%99s-Virtual-Hosts"><span class="nav-number">6.</span> <span class="nav-text">Nginx for Apache’s Virtual Hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-amp-Config-mod-rpaf"><span class="nav-number">7.</span> <span class="nav-text">Install &amp; Config mod_rpaf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTPS-with-Let%E2%80%99s-Encrypt"><span class="nav-number">8.</span> <span class="nav-text">HTTPS with Let’s Encrypt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Block-Direct-Access-to-Apache"><span class="nav-number">9.</span> <span class="nav-text">Block Direct Access to Apache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Serve-Static-Files-with-Nginx"><span class="nav-number">10.</span> <span class="nav-text">Serve Static Files with Nginx</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Merikanto"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Merikanto</p>
  <div class="site-description" itemprop="description">知我罪我，其惟春秋</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">Kategorien</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">Tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Merikanto" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Merikanto" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ks.merikanto@gmail.com" title="E-Mail → mailto:ks.merikanto@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title">
      　　
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.sigure.jp/" title="http:&#x2F;&#x2F;www.sigure.jp&#x2F;" rel="noopener" target="_blank">　凛として時雨　</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tools.kali.org/tools-listing" title="https:&#x2F;&#x2F;tools.kali.org&#x2F;tools-listing" rel="noopener" target="_blank">All Kali Tools</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.shodan.io/" title="https:&#x2F;&#x2F;www.shodan.io&#x2F;" rel="noopener" target="_blank">Shodan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://0pointer.net/blog/archives.html" title="https:&#x2F;&#x2F;0pointer.net&#x2F;blog&#x2F;archives.html" rel="noopener" target="_blank">Pid Eins</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.allthingsdistributed.com/" title="https:&#x2F;&#x2F;www.allthingsdistributed.com&#x2F;" rel="noopener" target="_blank">All Things Distributed</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.contrapositivediary.com/?p=1396" title="https:&#x2F;&#x2F;www.contrapositivediary.com&#x2F;?p&#x3D;1396" rel="noopener" target="_blank">Jeff Duntemann</a>
        </li>
    </ul>
  </div>

      </section>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/Merikanto" class="github-corner" title="Check out my GitHub" aria-label="Check out my GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="de">
    <link itemprop="mainEntityOfPage" href="http://merikanto.org/2018/Nginx-Config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Merikanto">
      <meta itemprop="description" content="知我罪我，其惟春秋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Merikanto">
    </span>

    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx as Web Server & Reverse Proxy for Apache with SSL
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              <time title="Erstellt: 2018-11-11 00:00:00" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+00:00">2018-11-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">in</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Debug-Config/" itemprop="url" rel="index"><span itemprop="name">Debug & Config</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Aufrufe" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="far fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Aufrufe: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbole im Artikel gezählt">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbole im Artikel gezählt: </span>
              <span>14k Wörter</span>
            </span>
            <span class="post-meta-item" title="Lesezeit">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Lesezeit &asymp;</span>
              <span>17 min</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Apache and Nginx are two popular open-source web servers often used with <strong>PHP</strong>. <u>It can be useful to run both of them on the same virtual machine when hosting multiple websites which have varied requirements</u>. The general solution for running two web servers on a single system is to either <u>use multiple IP addresses</u> or <u>use different port numbers</u>.</p>
<p>Servers which have both IPv4 and IPv6 addresses can be configured to serve Apache sites on one protocol and Nginx sites on the other, but this isn’t currently practical, as IPv6 adoption by ISPs is still not widespread. Having a different port number for the second web server is another solution, but sharing URLs with port numbers isn’t always ideal.</p>
<p>In this post, we will configure Nginx as <strong>both a web server and as a reverse proxy for Apache</strong> – all on a single server.</p>
<span id="more"></span> 

<br>

<p>Depending on the web application, code changes might be required to keep Apache reverse-proxy-aware, especially when SSL sites are configured. To avoid this, we will install an Apache module called <code>mod_rpaf</code> which rewrites certain environment variables so it appears that Apache is directly handling requests from web clients.</p>
<p>We will host four domain names on one server. Two will be served by Nginx: <code>example.com</code> (the default virtual host) and <code>sample.org</code>. The remaining two, <code>foobar.net</code> and <code>test.io</code>, will be served by Apache. We’ll also configure Apache to serve PHP applications using <code>PHP-FPM</code>, which offers better performance over <code>mod_php</code>.</p>
<br>

<blockquote>
<p>  Reference:</p>
<p>  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-server-blocks-virtual-hosts-on-ubuntu-16-04">Set Up Nginx Server Blocks</a></p>
<p>  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/nginx-essentials-installation-and-configuration-troubleshooting">Nginx Troubleshoot</a></p>
<p>  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-nginx-web-server-on-a-virtual-private-server">Configure Nginx</a></p>
<p>  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-configure-nginx-as-a-web-server-and-reverse-proxy-for-apache-on-one-ubuntu-18-04-server">Configure Nginx as Server &amp; Reverse Proxy</a></p>
<p>  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-16-04">Set Up Apache Virtual Host</a></p>
</blockquote>
<br>

<hr>
<h2 id="Config-Apache-amp-PHP-FPM"><a href="#Config-Apache-amp-PHP-FPM" class="headerlink" title="Config Apache &amp; PHP-FPM"></a>Config Apache &amp; PHP-FPM</h2><p>First:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install apache2 php-fpm</span><br><span class="line"></span><br><span class="line">wget https://mirrors.edge.kernel.org/ubuntu/pool/multiverse/liba \</span><br><span class="line">/libapache-mod-fastcgi/libapache2-mod-fastcgi_2.4.7~0910052141-1.2_amd64.deb</span><br><span class="line"></span><br><span class="line">sudo dpkg -i libapache2-mod-fastcgi_2.4.7~0910052141-1.2_amd64.deb</span><br></pre></td></tr></table></figure>

<p>In this step we will change Apache’s port number to 8080 and configure it to work with <code>PHP-FPM</code> using the <code>mod_fastcgi</code> module. Rename Apache’s <code>ports.conf</code> configuration file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">mv</span> <span class="string">/etc/apache2/ports.conf</span> <span class="string">/etc/apache2/ports.conf.default</span></span><br></pre></td></tr></table></figure>

<p>Create a new <code>ports.conf</code> file with the port set to 8080:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">&quot;Listen 8080&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/etc/apache2/ports.conf</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>Note: </p>
<p><em>Web servers are generally set to listen on <code>127.0.0.1:8080</code> when configuring a reverse proxy but doing so would set the value of PHP’s environment variable <code>SERVER_ADDR</code> to the loopback IP address instead of the server’s public IP. Our aim is to set up Apache in such a way that its websites do not see a reverse proxy in front of it. So, we will configure it to listen on 8080 on all IP addresses.</em></p>
</blockquote>
<br>

<p>Next we’ll create a virtual host file for Apache. The <code>&lt;VirtualHost&gt;</code> directive in this file will be set to serve sites only on port 8080.</p>
<p>Disable the default virtual host:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">a2dissite</span> <span class="number">000</span><span class="string">-default</span></span><br></pre></td></tr></table></figure>

<p>Then create a new virtual host file, using the existing default site:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">cp</span> <span class="string">/etc/apache2/sites-available/000-default.conf</span> <span class="string">\</span></span><br><span class="line"><span class="string">/etc/apache2/sites-available/001-default.conf</span></span><br></pre></td></tr></table></figure>

<p>Now open the new configuration file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/sites-available/001-default.conf</span></span><br></pre></td></tr></table></figure>

<p>Change the listening port to 8080:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerAdmin webmaster@localhost</span><br><span class="line">    DocumentRoot /var/www/html</span><br><span class="line">    ErrorLog <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/error.log</span><br><span class="line">    CustomLog <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/access.log combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>Save the file and activate the new configuration file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">a2ensite</span> <span class="number">001</span><span class="string">-default</span></span><br></pre></td></tr></table></figure>

<p>Then reload Apache:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">apache2</span></span><br></pre></td></tr></table></figure>

<p>Verify that Apache is now listening on 8080:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">netstat</span> <span class="string">-tlpn</span></span><br></pre></td></tr></table></figure>

<p>The output should look like the following example, with apache2 listening on 8080:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Output</span></span><br><span class="line"></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address     Foreign Address   State    PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:22        0.0.0.0:*         LISTEN   1086/sshd</span><br><span class="line">tcp6       0      0 :::8080           :::*              LISTEN   4678/apache2</span><br><span class="line">tcp6       0      0 :::22             :::*              LISTEN   1086/sshd</span><br></pre></td></tr></table></figure>

<p>Once we verify that Apache is listening on the correct port, we can configure support for PHP and <code>FastCGI</code>.</p>
<br>

<hr>
<h2 id="Use-mod-fastcgi"><a href="#Use-mod-fastcgi" class="headerlink" title="Use mod_fastcgi"></a>Use mod_fastcgi</h2><p>Apache serves PHP pages using <code>mod_php</code> by default, but it requires additional configuration to work with PHP-FPM.</p>
<blockquote>
<p>Note: If we are trying on an existing installation of LAMP with <code>mod_php</code>, disable it first with:</p>
<p><code>sudo a2dismod php7.3</code></p>
</blockquote>
<p>We will be adding a configuration block for <code>mod_fastcgi</code> which depends on <code>mod_action</code>. <code>mod_action</code> is disabled by default, so we first need to enable it:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">a2enmod</span> <span class="string">actions</span></span><br></pre></td></tr></table></figure>

<p>Rename the existing FastCGI configuration file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">mv</span> <span class="string">/etc/apache2/mods-enabled/fastcgi.conf</span> <span class="string">\</span></span><br><span class="line"><span class="string">/etc/apache2/mods-enabled/fastcgi.conf.default</span></span><br></pre></td></tr></table></figure>

<p>Create a new configuration file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/mods-enabled/fastcgi.conf</span></span><br></pre></td></tr></table></figure>

<p>Add the following directives to the file to pass requests for <code>.php</code> files to the PHP-FPM UNIX socket:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Content --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_fastcgi.c</span>&gt;</span></span><br><span class="line">  AddHandler fastcgi-script .fcgi</span><br><span class="line">  FastCgiIpcDir /var/lib/apache2/fastcgi</span><br><span class="line">  AddType application/x-httpd-fastphp .php</span><br><span class="line">  Action application/x-httpd-fastphp /php-fcgi</span><br><span class="line">  Alias /php-fcgi /usr/lib/cgi-bin/php-fcgi</span><br><span class="line">  FastCgiExternalServer /usr/lib/cgi-bin/php-fcgi -socket /run/php/php7.2-fpm.sock -pass-header Authorization</span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">usr</span>/<span class="attr">lib</span>/<span class="attr">cgi-bin</span>&gt;</span></span><br><span class="line">    Require all granted</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Save the changes and do a configuration test:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apachectl</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>Reload Apache if Syntax OK is displayed:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">apache2</span></span><br></pre></td></tr></table></figure>

<p>If we see the warning:</p>
<blockquote>
<p>  <em>Could not reliably determine the server’s fully qualified domain name, using 127.0.1.1. Set the ‘ServerName’ directive globally to suppress this message.</em></p>
</blockquote>
<p>We can safely ignore it for now. We’ll configure server names later.</p>
<p>Now let’s make sure we can serve PHP from Apache.</p>
<br>

<hr>
<h2 id="Verify-PHP-Functionality"><a href="#Verify-PHP-Functionality" class="headerlink" title="Verify PHP Functionality"></a>Verify PHP Functionality</h2><p>Let’s make sure that PHP works by creating a <code>phpinfo()</code> file and accessing it from a web browser.</p>
<p>Create the file <code>/var/www/html/info.php</code> which contains a call to the <code>phpinfo</code> function:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/www/html/info.php</span></span><br></pre></td></tr></table></figure>

<p>To see the file in a browser, go to <code>localhost:8080/info.php</code>. This will give us a list of the configuration settings PHP is using. We’ll see output similar to this:</p>
<p><img data-src="/images/posts/181111-0.png" alt="00"></p>
<p><img data-src="/images/posts/181111-1.png" alt="01"></p>
<p>At the top of the page, check that <strong>Server API</strong> says <strong>FPM/FastCGI</strong>. About two-thirds of the way down the page, the <strong>PHP Variables</strong> section will tell we the <strong>SERVER_SOFTWARE</strong> is Apache on Ubuntu. These confirm that mod_fastcgi is active and Apache is using PHP-FPM to process PHP files.</p>
<br>

<hr>
<h2 id="Create-Virtual-Hosts-for-Apache"><a href="#Create-Virtual-Hosts-for-Apache" class="headerlink" title="Create Virtual Hosts for Apache"></a>Create Virtual Hosts for Apache</h2><p>Let’s create Apache virtual host files for the domains <code>foobar.net</code> and <code>test.io</code>. To do that, we’ll first create document root directories for both sites and place some default files in those directories so we can easily test our configuration.</p>
<p>First, create the document root directories:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">mkdir</span> <span class="string">-v</span> <span class="string">/var/www/foobar.net</span> <span class="string">/var/www/test.io</span></span><br></pre></td></tr></table></figure>

<p>Then create an index file for each site:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;Foo Bar&lt;/h1&gt;&quot;</span> | sudo tee /var/www/foobar.net/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;Test IO&lt;/h1&gt;&quot;</span> | sudo tee /var/www/test.io/index.html</span><br></pre></td></tr></table></figure>

<p>Then create a <code>phpinfo()</code> file for each site so we can test that PHP is configured properly.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> | sudo tee /var/www/foobar.net/info.php</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> | sudo tee /var/www/test.io/info.php</span><br></pre></td></tr></table></figure>

<p>Now create the virtual host file for the <code>foobar.net</code> domain:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/sites-available/foobar.net.conf</span></span><br></pre></td></tr></table></figure>

<p>Add the following code to the file to define the host:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Content --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:8080</span>&gt;</span></span><br><span class="line">    ServerName foobar.net</span><br><span class="line">    ServerAlias www.foobar.net</span><br><span class="line">    DocumentRoot /var/www/foobar.net</span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/<span class="attr">foobar.net</span>&gt;</span></span><br><span class="line">        AllowOverride All</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The line <code>AllowOverride All</code> enables <code>.htaccess</code> support. Save and close the file. Then create a similar configuration for <code>test.io</code>. First create the file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/sites-available/test.io.conf</span></span><br></pre></td></tr></table></figure>

<p>Then add the configuration to the file:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Content --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:8080</span>&gt;</span></span><br><span class="line">    ServerName test.io</span><br><span class="line">    ServerAlias www.test.io</span><br><span class="line">    DocumentRoot /var/www/test.io</span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/<span class="attr">test.io</span>&gt;</span></span><br><span class="line">        AllowOverride All</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Now that both Apache virtual hosts are set up, enable the sites using the <code>a2ensite</code> command. This creates a symbolic link to the virtual host file in the sites-enabled directory:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">a2ensite</span> <span class="string">foobar.net</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">a2ensite</span> <span class="string">test.io</span></span><br></pre></td></tr></table></figure>

<p>Check Apache for configuration errors again:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apachectl</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>We’ll see <strong>Syntax OK</strong> displayed if there are no errors. If we see anything else, review the configuration and try again.</p>
<p>Reload Apache to apply the changes once our configuration is error-free:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">apache2</span></span><br></pre></td></tr></table></figure>

<p>To confirm the sites are working, open <code>http://foobar.net:8080</code> and <code>http://test.io:8080</code> in the browser and verify that each site displays its <code>index.html</code> file.</p>
<p>We’ll see the following results:</p>
<p><img data-src="/images/posts/181111-2.png" alt="02"></p>
<p><img data-src="/images/posts/181111-3.png" alt="03"></p>
<p>Also, ensure that PHP is working by accessing the <code>info.php</code> files for each site. Visit <code>http://foobar.net:8080/info.php</code> and <code>http://test.io:8080/info.php</code> in the browser.</p>
<p>We now have two websites hosted on Apache at port 8080. Let’s configure Nginx next.</p>
<br>

<hr>
<h2 id="Install-amp-Config-Nginx"><a href="#Install-amp-Config-Nginx" class="headerlink" title="Install &amp; Config Nginx"></a>Install &amp; Config Nginx</h2><p>In this step we’ll install Nginx and configure the domains <code>example.com</code> and <code>sample.org</code> as Nginx’s virtual hosts. After install Nginx, remove the default virtual host’s symlink since we won’t be using it any more:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">rm</span> <span class="string">/etc/nginx/sites-enabled/default</span></span><br></pre></td></tr></table></figure>

<p>We’ll create our own default site later (<code>example.com</code>).</p>
<p>Now we’ll create virtual hosts for Nginx using the same procedure we used for Apache. First create document root directories for both the websites:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">mkdir</span> <span class="string">-v</span> <span class="string">/usr/share/nginx/example.com</span> <span class="string">/usr/share/nginx/sample.org</span></span><br></pre></td></tr></table></figure>

<p>We’ll keep the Nginx web sites in <code>/usr/share/nginx</code>, which is where Nginx wants them by default. We could put them under <code>/var/www/html</code> with the Apache sites, but this separation may help you associate sites with Nginx.</p>
<p>As you did with Apache’s virtual hosts, create index and <code>phpinfo()</code> files for testing after setup is complete:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;Example.com&lt;/h1&gt;&quot;</span> | sudo tee /usr/share/nginx/example.com/index.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;Sample.org&lt;/h1&gt;&quot;</span> | sudo tee /usr/share/nginx/sample.org/index.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> | sudo tee /usr/share/nginx/example.com/info.php</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> | sudo tee /usr/share/nginx/sample.org/info.php</span><br></pre></td></tr></table></figure>

<p>Now create a virtual host file for the domain <code>example.com</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/nginx/sites-available/example.com</span></span><br></pre></td></tr></table></figure>

<p>Nginx calls server {. . .} areas of a configuration file server blocks. Create a server block for the primary virtual host, <code>example.com</code>. The <code>default_server</code> configuration directive makes this the default virtual host which processes HTTP requests which do not match any other virtual host.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line"></span><br><span class="line">    root /usr/share/nginx/example.com;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass unix:/run/php/php7.2-fpm.sock;</span><br><span class="line">        include snippets/fastcgi-php.conf;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now create a virtual host file for Nginx’s second domain, <code>sample.org</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">etc/nginx/sites-available/sample.org</span></span><br></pre></td></tr></table></figure>
<p>Add the following to the file:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    root /usr/share/nginx/sample.org;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    server_name sample.org www.sample.org;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass unix:/run/php/php7.2-fpm.sock;</span><br><span class="line">        include snippets/fastcgi-php.conf;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then enable both sites by creating symbolic links to the sites-enabled directory:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">ln</span> <span class="string">-s</span> <span class="string">/etc/nginx/sites-available/example.com</span> <span class="string">\</span></span><br><span class="line"><span class="string">/etc/nginx/sites-enabled/example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">ln</span> <span class="string">-s</span> <span class="string">/etc/nginx/sites-available/sample.org</span> <span class="string">\</span></span><br><span class="line"><span class="string">/etc/nginx/sites-enabled/sample.org</span></span><br></pre></td></tr></table></figure>

<p>Then test the Nginx configuration to ensure there are no configuration issues:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">nginx</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>Then reload Nginx if there are no errors:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>Now access the <code>phpinfo()</code> file of our Nginx virtual hosts in a web browser by visiting <code>http://example.com/info.php</code> and <code>http://sample.org/info.php</code>. Look under the PHP Variables sections again.</p>
<p><img data-src="/images/posts/181111-4.png" alt="04"></p>
<p><strong>[“SERVER_SOFTWARE”]</strong> should say nginx, indicating that the files were directly served by Nginx. <strong>[“DOCUMENT_ROOT”]</strong> should point to the directory we created earlier in this step for each Nginx site.</p>
<p>At this point, we have installed Nginx and created two virtual hosts. Next we will configure Nginx to proxy requests meant for domains hosted on Apache.</p>
<br>

<hr>
<h2 id="Nginx-for-Apache’s-Virtual-Hosts"><a href="#Nginx-for-Apache’s-Virtual-Hosts" class="headerlink" title="Nginx for Apache’s Virtual Hosts"></a>Nginx for Apache’s Virtual Hosts</h2><p>Let’s create an additional Nginx virtual host with multiple domain names in the server_name directives. Requests for these domain names will be proxied to Apache.</p>
<p>Create a new Nginx virtual host file to forward requests to Apache:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/nginx/sites-available/apache</span></span><br></pre></td></tr></table></figure>

<p>Add the following code block which specifies the names of both Apache virtual host domains and proxies their requests to Apache. Remember to use the public IP address in <code>proxy_pass</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name foobar.net www.foobar.net test.io www.test.io;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://your_server_ip:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Save the file and enable this new virtual host by creating a symbolic link:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">ln</span> <span class="string">-s</span> <span class="string">/etc/nginx/sites-available/apache</span> <span class="string">/etc/nginx/sites-enabled/apache</span></span><br></pre></td></tr></table></figure>

<p>Test the configuration to ensure there are no errors:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">nginx</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>If there are no errors, reload Nginx:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>Open the browser and access the URL <a target="_blank" rel="noopener" href="http://foobar.net/info.php">http://foobar.net/info.php</a> in the browser. Scroll down to the PHP Variables section and check the values displayed.</p>
<p><img data-src="/images/posts/181111-5.png" alt="05"></p>
<p>The variables <strong>SERVER_SOFTWARE</strong> and <strong>DOCUMENT_ROOT</strong> confirm that this request was handled by Apache. The variables <strong>HTTP_X_REAL_IP</strong> and <strong>HTTP_X_FORWARDED_FOR</strong> were added by Nginx and should show the public IP address of the computer we’re using to access the URL.</p>
<p>We have successfully set up Nginx to proxy requests for specific domains to Apache. Next, let’s configure Apache to set the <code>REMOTE_ADDR</code> variable as if it were handling these requests directly.</p>
<br>

<hr>
<h2 id="Install-amp-Config-mod-rpaf"><a href="#Install-amp-Config-mod-rpaf" class="headerlink" title="Install &amp; Config mod_rpaf"></a>Install &amp; Config mod_rpaf</h2><p>Now we will install an Apache module called <code>mod\_rpaf</code> which rewrites the values of <code>REMOTE_ADDR</code>, HTTPS and HTTP_PORT based on the values provided by a reverse proxy. Without this module, some PHP applications would require code changes to work seamlessly from behind a proxy. This module is present in Ubuntu’s repository as <code>libapache2-mod-rpaf</code> but is outdated and doesn’t support certain configuration directives. Instead, we will install it from source.</p>
<p>Install the packages needed to build the module:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">unzip</span> <span class="string">build-essential</span> <span class="string">apache2-dev</span></span><br></pre></td></tr></table></figure>

<p>Download the latest stable release from GitHub:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">wget</span> <span class="string">https://github.com/gnif/mod_rpaf/archive/stable.zip</span></span><br></pre></td></tr></table></figure>

<p>Extract the downloaded file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">unzip</span> <span class="string">stable.zip</span></span><br></pre></td></tr></table></figure>

<p>Change into the new directory containing the files:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">mod_rpaf-stable</span></span><br></pre></td></tr></table></figure>

<p>Compile and install the module:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">make</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">make</span> <span class="string">install</span></span><br></pre></td></tr></table></figure>

<p>Next, create a file in the mods-available directory which will load the <code>rpaf</code> module:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/mods-available/rpaf.load</span></span><br></pre></td></tr></table></figure>

<p>Add the following code to the file to load the module:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">LoadModule rpaf_module /usr/lib/apache2/modules/mod_rpaf.so</span><br></pre></td></tr></table></figure>

<p>Create another file in this directory called <code>rpaf.conf</code> which will contain the configuration directives for <code>mod_rpaf</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/apache2/mods-available/rpaf.conf</span></span><br></pre></td></tr></table></figure>

<p>Add the following code block to configure <code>mod_rpaf</code>, making sure to specify the IP address of the server:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Content --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_rpaf.c</span>&gt;</span></span><br><span class="line">    RPAF_Enable             On</span><br><span class="line">    RPAF_Header             X-Real-Ip</span><br><span class="line">    RPAF_ProxyIPs           your_server_ip </span><br><span class="line">    RPAF_SetHostName        On</span><br><span class="line">    RPAF_SetHTTPS           On</span><br><span class="line">    RPAF_SetPort            On</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Here’s a brief description of each directive. See the <code>mod_rpaf</code> README file for more information.</p>
<ul>
<li><p><code>RPAF_Header</code> - The header to use for the client’s real IP address.</p>
</li>
<li><p><code>RPAF_ProxyIPs</code> - The proxy IP to adjust HTTP requests for.</p>
</li>
<li><p><code>RPAF_SetHostName</code> - Updates the vhost name so <code>ServerName</code> and <code>ServerAlias</code> work.</p>
</li>
<li><p><code>RPAF_SetHTTPS</code> - Sets the HTTPS environment variable based on the value contained in <code>X-Forwarded-Proto</code>.</p>
</li>
<li><p><code>RPAF_SetPort</code> - Sets the SERVER_PORT environment variable. Useful for when Apache is behind a SSL proxy.</p>
</li>
</ul>
<p>Save <code>rpaf.conf</code> and enable the module:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">a2enmod</span> <span class="string">rpaf</span></span><br></pre></td></tr></table></figure>

<p>This creates symbolic links of the files <code>rpaf.load</code> and <code>rpaf.conf</code> in the mods-enabled directory. Now do a configuration test:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apachectl</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>Reload Apache if there are no errors:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">reload</span> <span class="string">apache2</span></span><br></pre></td></tr></table></figure>

<p>Access the <code>phpinfo()</code> pages <a target="_blank" rel="noopener" href="http://foobar.net/info.php">http://foobar.net/info.php</a> and <a target="_blank" rel="noopener" href="http://test.io/info.php">http://test.io/info.php</a> in our browser and check the PHP Variables section. The <code>REMOTE_ADDR</code> variable will now also be that of the local computer’s public IP address.</p>
<p>Now let’s set up TLS/SSL encryption for each site.</p>
<br>

<h2 id="HTTPS-with-Let’s-Encrypt"><a href="#HTTPS-with-Let’s-Encrypt" class="headerlink" title="HTTPS with Let’s Encrypt"></a>HTTPS with Let’s Encrypt</h2><p>In this step we will configure TLS/SSL certificates for both the domains hosted on Apache. We’ll obtain the certificates through <a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a>. Nginx supports SSL termination so we can set up SSL without modifying Apache’s configuration files. The <code>mod_rpaf</code> module ensures the required environment variables are set on Apache to make applications work seamlessly behind a SSL reverse proxy.</p>
<p>First we will separate the server {…} blocks of both the domains so that each of them can have their own SSL certificates. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/nginx/sites-available/apache</span></span><br></pre></td></tr></table></figure>

<p>Modify the file so that it looks like this, with <code>foobar.net</code> and<code> test.io</code> in their own server blocks:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name foobar.net www.foobar.net;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://your_server_ip:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.io www.test.io;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://your_server_ip:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We’ll use Certbot to generate our TLS/SSL certificates. Its Nginx plugin will take care of reconfiguring Nginx and reloading the config whenever necessary.</p>
<p>First, add the official Certbot repository:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">add-apt-repository</span> <span class="string">ppa:certbot/certbot</span></span><br></pre></td></tr></table></figure>

<p>Press ENTER when prompted to confirm that we want to add the new repository. Then update the package list to pick up the new repository’s package information:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">update</span></span><br></pre></td></tr></table></figure>

<p>Then install Certbot’s Nginx package with apt:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python-certbot-nginx</span></span><br></pre></td></tr></table></figure>

<p>Once it’s installed, use the certbot command to generate the certificates for <code>foobar.net</code> and <a target="_blank" rel="noopener" href="http://www.foobar.net/">www.foobar.net</a>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">certbot</span> <span class="string">--nginx</span> <span class="string">-d</span> <span class="string">foobar.net</span> <span class="string">-d</span> <span class="string">www.foobar.net</span></span><br></pre></td></tr></table></figure>

<p>This command tells Certbot to use the Nginx plugin, using -d to specify the names we’d like the certificate to be valid for.</p>
<p>If this is our first time running certbot, we will be prompted to enter an email address and agree to the terms of service. After doing so, certbot will communicate with the Let’s Encrypt server, then run a challenge to verify that we control the domain we’re requesting a certificate for.</p>
<p>Next, Certbot will ask how we’d like to configure our HTTPS settings:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Output</span></span><br><span class="line"></span><br><span class="line">Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1: No redirect - Make no further changes to the webserver configuration.</span><br><span class="line">2: Redirect - Make all requests redirect to secure HTTPS access. Choose this <span class="keyword">for</span></span><br><span class="line">new sites, or <span class="keyword">if</span> we<span class="string">&#x27;re confident your site works on HTTPS. You can undo this</span></span><br><span class="line"><span class="string">change by editing your web server&#x27;</span>s configuration.</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>


<p>Select your choice, then press ENTER. The configuration will be updated, and Nginx will reload to pick up the new settings. Now execute the command for the second domain:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">certbot</span> <span class="string">--nginx</span> <span class="string">-d</span> <span class="string">test.io</span> <span class="string">-d</span> <span class="string">www.test.io</span></span><br></pre></td></tr></table></figure>

<p>Access one of Apache’s domains in the browser using the https:// prefix; visit <a target="_blank" rel="noopener" href="https://foobar.net/info.php">https://foobar.net/info.php</a> and we’ll see this:</p>
<p><img data-src="/images/posts/181111-6.png" alt="06"></p>
<p>Look in the PHP Variables section. The variable <code>SERVER_PORT</code> has been set to 443 and HTTPS set to on, as though Apache was directly accessed over HTTPS. With these variables set, PHP applications do not have to be specially configured to work behind a reverse proxy.</p>
<p>Now let’s disable direct access to Apache.</p>
<br>

<hr>
<h2 id="Block-Direct-Access-to-Apache"><a href="#Block-Direct-Access-to-Apache" class="headerlink" title="Block Direct Access to Apache"></a>Block Direct Access to Apache</h2><p>Since Apache is listening on port 8080 on the public IP address, it is accessible by everyone. It can be blocked by working the following <code>IPtables</code> command into your firewall rule set.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">iptables</span> <span class="string">-I</span> <span class="string">INPUT</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">--dport</span> <span class="number">8080</span> <span class="string">!</span> <span class="string">\</span></span><br><span class="line"><span class="string">-s</span> <span class="string">your_server_ip</span> <span class="string">-j</span> <span class="string">REJECT</span> <span class="string">--reject-with</span> <span class="string">tcp-reset</span></span><br></pre></td></tr></table></figure>

<p>Be sure to use your server’s IP address in place of the example in red. Once port 8080 is blocked in your firewall, test that Apache is unreachable on it. Open your web browser and try accessing one of Apache’s domain names on port 8080. For example: <a target="_blank" rel="noopener" href="http://example.com:8080/">http://example.com:8080</a></p>
<p>The browser should display an <code>Unable to connect</code> or <code>Webpage is not available</code> error message. With the IPtables <code>tcp-reset </code>option in place, an outsider would see no difference between port 8080 and a port that doesn’t have any service on it.</p>
<blockquote>
<p>Note: </p>
<p><em>IPtables rules do not survive a system reboot by default. There are multiple ways to preserve IPtables rules, but the easiest is to use iptables-persistent in Ubuntu’s repository. Explore this article to learn more about how to configure IPTables.</em></p>
</blockquote>
<p>Now let’s configure Nginx to serve static files for the Apache sites.</p>
<br>

<hr>
<h2 id="Serve-Static-Files-with-Nginx"><a href="#Serve-Static-Files-with-Nginx" class="headerlink" title="Serve Static Files with Nginx"></a>Serve Static Files with Nginx</h2><p>When Nginx proxies requests for Apache’s domains, it sends every file request for that domain to Apache. Nginx is faster than Apache in serving static files like images, JavaScript and style sheets. So let’s configure Nginx’s apache virtual host file to directly serve static files but send PHP requests on to Apache.</p>
<p>Open the file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">vim</span> <span class="string">/etc/nginx/sites-available/apache</span></span><br></pre></td></tr></table></figure>
<p>You’ll need to add two additional location blocks to each server block, as well as modify the existing location sections. In addition, you’ll need to tell Nginx where to find the static files for each site.</p>
<p>If you’ve decided not to use SSL and TLS certificates, modify your file so it looks like this:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.io www.test.io;</span><br><span class="line">    root /var/www/test.io;</span><br><span class="line">    index index.php index.htm index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        proxy_pass http://your_server_ip:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name foobar.net www.foobar.net;</span><br><span class="line">    root /var/www/foobar.net;</span><br><span class="line">    index index.php index.htm index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        proxy_pass http://your_ip_address:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you also want HTTPS to be available, use the following configuration instead:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.io www.test.io;</span><br><span class="line">    root /var/www/test.io;</span><br><span class="line">    index index.php index.htm index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        proxy_pass http://your_server_ip:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/test.io/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/test.io/privkey.pem;</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name foobar.net www.foobar.net;</span><br><span class="line">    root /var/www/foobar.net;</span><br><span class="line">    index index.php index.htm index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        proxy_pass http://your_ip_address:8080;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/foobar.net/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/foobar.net/privkey.pem;</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>try_files</code> directive makes Nginx look for files in the document root and directly serve them. If the file has a <code>.php</code> extension, the request is passed to Apache. Even if the file is not found in the document root, the request is passed on to Apache so that application features like permalinks work without problems.</p>
<blockquote>
<p><strong>Warning:</strong> </p>
<p>The location <code>~ /.ht</code> directive is very important; this prevents Nginx from serving the contents of Apache configuration files like <code>.htaccess</code> and <code>.htpasswd</code> which contain sensitive information.</p>
</blockquote>
<p>Save the file and perform a configuration test:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">nginx</span> <span class="string">-t</span></span><br></pre></td></tr></table></figure>

<p>Reload Nginx if the test succeeds:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">service</span> <span class="string">nginx</span> <span class="string">reload</span></span><br></pre></td></tr></table></figure>

<p>To verify things are working, you can examine Apache’s log files in <code>/var/log/apache2</code> and see the GET requests for the <code>info.php </code>files of <code>test.io</code> and <code>foobar.net</code>. Use the tail command to see the last few lines of the file, and use the -f switch to watch the file for changes:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">tail</span> <span class="string">-f</span> <span class="string">/var/log/apache2/other_vhosts_access.log</span></span><br></pre></td></tr></table></figure>

<p>Now visit <a target="_blank" rel="noopener" href="http://test.io/info.php">http://test.io/info.php</a> in your browser and then look at the output from the log. You’ll see that Apache is indeed replying:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Output</span></span><br><span class="line"></span><br><span class="line">test.io:80 your_server_ip - - [01/Jul/2016:18:18:34 -0400] </span><br><span class="line"><span class="string">&quot;GET /info.php HTTP/1.0&quot;</span> 200 20414 <span class="string">&quot;-&quot;</span> </span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 \</span></span><br><span class="line"><span class="string">(KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36&quot;</span></span><br></pre></td></tr></table></figure>

<p>Then visit the <code>index.html</code> page for each site and you won’t see any log entries from Apache. Nginx is serving them.</p>
<p>With this setup, Apache will not be able to restrict access to static files. And access control for static files would need to be configured in Nginx’s apache virtual host file.</p>
<br>

<br>
    </div>

    
    
    <div>
    
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Beitragsautor:  </strong>Merikanto
  </li>
  <li class="post-copyright-link">
    <strong>Beitragslink: </strong>
    <a href="http://merikanto.org/2018/Nginx-Config/" title="Nginx as Web Server &amp; Reverse Proxy for Apache with SSL">http://merikanto.org/2018/Nginx-Config/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Urheberrechtshinweis:  </strong>Alle Artikel in diesem Blog sind unter <a target="_blank" rel="noopener" href="https://github.com/Merikanto">Merikanto</a> lizenziert, außer es wird anders angegeben.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DevOps/" rel="tag"><i class="fa fa-tag"></i> DevOps</a>
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/Apache-Config/" rel="prev" title="Configure Apache on Ubuntu">
      <i class="fa fa-chevron-left"></i> Configure Apache on Ubuntu
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/Load-Balancer/" rel="next" title="HAProxy & Load Balancing">
      HAProxy & Load Balancing <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>  
  </span>
  <a href="/tools"><span class="author" itemprop="copyrightHolder">Merikanto</span></a>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Alle Besucher">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Alle Aufrufe">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>


  

  
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#ededed',
  buttonColorLight: '#4a4a4a',
  saveInCookies: true,
  label: '◒',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

<script>
  var disqus_config = function() {
    this.page.url = "http://merikanto.org/2018/Nginx-Config/";
    this.page.identifier = "2018/Nginx-Config/";
    this.page.title = "Nginx as Web Server & Reverse Proxy for Apache with SSL";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://Merikanto-Blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>


  <script async src="/js/cursor/love.min.js"></script>

</body>
</html>
